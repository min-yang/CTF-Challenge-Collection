# 题目描述

I heard that some common block cipher modes have lots of footguns - using none (ECB) results in the legendary [ECB Penguin](https://words.filippo.io/the-ecb-penguin/), while others are vulnerable to [bit flipping](https://en.wikipedia.org/wiki/Bit-flipping_attack) and [padding](https://en.wikipedia.org/wiki/Padding_oracle_attack) attacks, so I made my own that would never fall to such a technique.

# 解决方案

根据加密脚本，每256个字节一组，但是我们不需要传输256个以上的字节，因此不用考虑，256字节又被分成16个组，每组16个字节，加密的输入不是原始输入，会按照指定规则打乱，每16个字节的偏移i会被映射到第j个块，可以本地调试观察输入输出来理解这个转换，下面给出一个例子：

```python
PERMUTATION = [11, 10, 4, 9, 12, 13, 7, 14, 8, 15, 5, 0, 3, 1, 2, 6]
inp = '20007b2274797065223a20226563686f222c20226d7367223a20226161616161227d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
data = '2261000000000000000000000000000020220000000000000000000000000000746d00000000000000000000000000003a20000000000000000000000000000065610000000000000000000000000000636100000000000000000000000000006522000000000000000000000000000068610000000000000000000000000000223a00000000000000000000000000006f610000000000000000000000000000797300000000000000000000000000002022220000000000000000000000000022220000000000000000000000000000002c7d000000000000000000000000007b20000000000000000000000000000070670000000000000000000000000000'
```

其中inp为原始输入，data为输出，都通过hex形式表示，PERMUTATION为映射关系，先将输入分为16个一组，如下：

| Offset |  0 |  1 |  2 |  3 |  4 |  5 |  6 |  7 |  8 |  9 | 10 | 11 | 12 | 13 | 14 | 15 |
| --- | --- |
|    0   | 20 | 00 | 7b | 22 | 74 | 79 | 70 | 65 | 22 | 3a | 20 | 22 | 65 | 63 | 68 | 6f | 
|    1   | 22 | 2c | 20 | 22 | 6d | 73 | 67 | 22 | 3a | 20 | 22 | 61 | 61 | 61 | 61 | 61 | 
|    2   | 22 | 7d | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    3   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    4   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    5   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    6   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    7   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    8   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|    9   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|   10   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|   11   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|   12   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|   13   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|   14   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 
|   15   | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 00 | 

映射关系的第一项的值为11，即输入各组的第12个字节组成输出的前16个字节，所以输出的前16个字节的hex为：`22610000000000000000000000000000`，映射关系的第二项的值为10，对应的16个输出字节的hex为：`20220000...`，以此类推，得到打乱后的输出，然后经过AES-ECB加密后展现给客户端。

这里的解决思路是，先尝试修改16个组的字节，看看哪个组修改后会改变echo四个字符的值（只要将echo改成flag即可拿到flag），但是修改加密后的字符，解密后原始输入那一列的值都有可能会修改，可能导致解析错误，echo在输入中的偏移是12～15（从0开始计算），如下表所示：

| Offset |  0 |  1 |  2 |  3 |  4 |  5 |  6 |  7 |  8 |  9 | 10 | 11 | 12 | 13 | 14 | 15 |
| --- | --- |
|    0   |    |    |  { |  " |  t |  y |  p |  e |  " |  : |    |  " |  e |  c |  h |  o | 
|    1   |  " |  , |    |  " |  m |  s |  g |  " |  : |    |  " |  a |  a |  a |  a |  a | 
|    2   |  " |  } |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    3   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    4   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    5   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    6   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    7   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    8   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|    9   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|   10   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|   11   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|   12   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|   13   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|   14   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
|   15   |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    | 
